<!DOCTYPE html>
<html lang="ur">
<head>
<meta charset="UTF-8">
<title>جامعہ اسلامیہ انوار العلوم العلمية - نظام نتائج</title>
<style>
body{font-family:Urdu Typesetting,Arial;background:#eef}
h2{text-align:center;color:teal;margin-bottom:10px}
.container{max-width:1000px;margin:auto;background:#fff;padding:20px;border:3px solid teal}
input,button,select{padding:6px;margin:4px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #333;padding:6px;text-align:center}
.pass{color:green;font-weight:bold}
.fail{color:red;font-weight:bold}
.hidden{display:none}
#cert{border:5px double teal;padding:20px;margin-top:10px;background:#fff}
@media print{
body *{visibility:hidden;}
#cert, #cert *{visibility:visible;}
#cert{position:absolute;left:0;top:0;width:100%;}
}
</style>
</head>
<body>

<h2>جامعہ اسلامیہ انوار العلوم العلمية</h2>
<div class="container">

<!-- STUDENT SEARCH -->
<div id="studentBox">
<input id="rollInput" placeholder="رول نمبر لکھیں">
<button onclick="search()">تلاش کریں</button>
<div id="output"></div>
<hr>
<button onclick="showAdmin()">ایڈمن لاگ ان</button>
</div>

<!-- LOGIN -->
<div id="loginBox" class="hidden">
<h3>ایڈمن لاگ ان</h3>
<input id="auser" placeholder="یوزر نیم">
<input id="apass" type="password" placeholder="پاسورڈ">
<button onclick="login()">لاگ ان</button>
<button onclick="back()">واپس جائیں</button>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" class="hidden">
<h3>ایڈمن پینل</h3>

<input id="rroll" placeholder="رول نمبر">
<input id="rname" placeholder="نام">
<input id="rfather" placeholder="والد">
<select id="rclass">
  <option value="">کلاس منتخب کریں</option>
  <option value="متوسطہ">متوسطہ</option>
  <option value="عامہ اول">عامہ اول</option>
  <option value="عامہ دوم">عامہ دوم</option>
  <option value="خاصہ اول">خاصہ اول</option>
  <option value="خاصہ دوم">خاصہ دوم</option>
  <option value="عالیہ اول">عالیہ اول</option>
  <option value="عالیہ دوم">عالیہ دوم</option>
  <option value="علمیہ اول">علمیہ اول</option>
  <option value="علمیہ دوم">علمیہ دوم</option>
  <option value="تخصص اول">تخصص اول</option>
  <option value="تخصص دوم">تخصص دوم</option>
</select>

<h4>کتاب / مضامین</h4>
<div id="subs"></div>
<button onclick="addSubject()">+ کتاب شامل کریں</button>

<h4>ترتیبات</h4>
<input type="file" id="logoInput">
<button onclick="saveLogo()">لوگو محفوظ کریں</button>
<br><br>
<input id="oldPass" type="password" placeholder="پرانا پاسورڈ">
<input id="newPass" type="password" placeholder="نیا پاسورڈ">
<button onclick="changePass()">پاسورڈ تبدیل کریں</button>
<hr>

<button onclick="addResult()">نتیجہ محفوظ کریں</button>
<button onclick="clearAll()">تمام نتائج حذف کریں</button>
<button onclick="logout()">لاگ آؤٹ</button>

<h4>تمام نتائج</h4>
<table id="list"></table>
</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// --- Admin Credentials ---
let ADMIN_USER="Qamar";
let ADMIN_PASS=localStorage.getItem("adminPass")||"Qamar1654";

// --- Data Storage ---
let data = JSON.parse(localStorage.getItem("results")||"[]");

// --- Functions ---
function save(){localStorage.setItem("results",JSON.stringify(data));}

// Add Subject Input
function addSubject(){
let d=document.createElement("div");
d.innerHTML=`<input placeholder="نام کتاب"><input type="number" placeholder="مارکس"> 
<button onclick="editSubject(this)">✎</button>
<button onclick="delSubject(this)">X</button>`;
subs.appendChild(d);
}
function editSubject(btn){
let div=btn.parentElement;
let name=prompt("نیا نام لکھیں",div.children[0].value);
let marks=prompt("نئے مارکس لکھیں",div.children[1].value);
if(name) div.children[0].value=name;
if(marks) div.children[1].value=marks;
}
function delSubject(btn){btn.parentElement.remove();}

// Calculate Grade
function getGrade(marks){
  if(marks>=80) return "ممتاز اعلی";
  else if(marks>=70) return "ممتاز";
  else if(marks>=50) return "جید";
  else if(marks>=40) return "مقبول";
  else return "ناکام";
}

// Search Result
function search(){
let r=rollInput.value;
let f=data.find(x=>x.roll==r);
if(!f){output.innerHTML="❌ رزلٹ نہیں ملا";return;}

// PRC auto
let prcNo = f.prc || (Math.floor(1000 + Math.random()*9000));

// Logo
let logo = localStorage.getItem("madrasaLogo") || "";
let logoHTML = logo ? `<img src="${logo}" style="width:80px">` : "";

// Total & Status
let total = f.subjects.reduce((a,b)=>a+b.marks,0);
let max = f.subjects.length*100;
let per = (total/max*100).toFixed(2);
let statusText = per>=40 ? "پاس" : "ناکام";

// Build Certificate HTML
let h = `<div id="cert">
<div style="display:flex;align-items:center;justify-content:space-between">
${logoHTML}
<div style="text-align:center">
<h2>جامعہ اسلامیہ انوار العلوم العلمية</h2>
<h4>نتیجہ سرٹیفکیٹ (TRF)</h4>
</div>
</div>
<hr>
<b>PRC No:</b> ${prcNo}<br>
<b>نام:</b> ${f.name}<br>
<b>والد:</b> ${f.father}<br>
<b>کلاس:</b> ${f.class}<br>
<table><tr><th>کتاب</th><th>مارکس</th><th>کیفیت</th></tr>`;

f.subjects.forEach(s=>{
  h+=`<tr><td>${s.name}</td><td>${s.marks}</td><td>${getGrade(s.marks)}</td></tr>`;
});

h+=`</table>
<h4>کل مارکس: ${total}/${max}</h4>
<h4>فیصد: ${per}%</h4>
<h4>کیفیت: ${statusText}</h4>
<br>
<button onclick="printPDF()">پی ڈی ایف پرنٹ کریں</button>
</div>`;

output.innerHTML=h;
}

// Print PDF using jsPDF
function printPDF(){
const { jsPDF } = window.jspdf;
let doc = new jsPDF();
doc.html(document.getElementById("cert"),{
  callback: function(pdf){pdf.save("TRF_Result.pdf");},
  x:10,y:10,width:180
});
}

// Show / Hide Admin
function showAdmin(){studentBox.classList.add("hidden");loginBox.classList.remove("hidden");}
function back(){loginBox.classList.add("hidden");studentBox.classList.remove("hidden");}
function login(){
if(auser.value==ADMIN_USER && apass.value==ADMIN_PASS){
loginBox.classList.add("hidden");
adminPanel.classList.remove("hidden");
render();
}else alert("غلط یوزر یا پاسورڈ");
}
function logout(){adminPanel.classList.add("hidden");studentBox.classList.remove("hidden");}

// Add / Update Result
function addResult(){
let subsArr=[];
[...subs.children].forEach(d=>{
let n=d.children[0].value;
let m=+d.children[1].value;
if(n && m>=0) subsArr.push({name:n,marks:m});
});
if(!rroll.value){alert("رول نمبر ضروری ہے");return;}
let obj={
  roll:rroll.value,
  name:rname.value,
  father:rfather.value,
  class:rclass.value,
  subjects:subsArr,
  prc: Math.floor(1000 + Math.random()*9000)
};
let i=data.findIndex(x=>x.roll==obj.roll);
if(i>=0) data[i]=obj; else data.push(obj);
save(); render(); alert("نتیجہ محفوظ ہو گیا!");
subs.innerHTML="";
}

// Render Result List
function render(){
let t="<tr><th>رول نمبر</th><th>نام</th><th>حذف کریں</th></tr>";
data.forEach((x,i)=>{
t+=`<tr><td>${x.roll}</td><td>${x.name}</td>
<td><button onclick="del(${i})">X</button></td></tr>`;
});
list.innerHTML=t;
}

// Delete Result
function del(i){data.splice(i,1);save();render();}

// Clear All Results
function clearAll(){if(confirm("تمام نتائج حذف کریں؟")){data=[];save();render();}}

// Logo Save
function saveLogo(){
let file=logoInput.files[0];
let reader=new FileReader();
reader.onload=function(){localStorage.setItem("madrasaLogo",reader.result);alert("لوگو محفوظ ہو گیا");}
reader.readAsDataURL(file);
}

// Change Admin Password
function changePass(){
if(oldPass.value!==ADMIN_PASS){alert("پرانا پاسورڈ غلط ہے");return;}
ADMIN_PASS=newPass.value;
localStorage.setItem("adminPass",ADMIN_PASS);
alert("پاسورڈ تبدیل ہو گیا");
oldPass.value=""; newPass.value="";
}
</script>
</body>
</html>
